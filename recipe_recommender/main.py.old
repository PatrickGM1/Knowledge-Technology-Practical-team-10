import streamlit as st
from pathlib import Path
from models import (
    Recipe, Diet, DietRestriction, CookingTime, 
    Skill, CookingMethod, Budget, Meal, Macros
)
from models.allergy import Allergy
from models.budget_constraint import BudgetConstraint
from models.cooking_skill import CookingSkill
from models.time_constraint import TimeConstraint
from models.dietary_preference import DietaryPreference
from models.health_goal import HealthGoal
from models.kitchen import Kitchen
from data.sample_recipes import get_all_recipes

st.set_page_config(
    page_title="Recipe Recommender",
    layout="wide"
)

st.title("üîç Find Your Perfect Recipe")
st.write("Answer the questions one at a time to find recipes that match your preferences!")
st.divider()

# All quiz questions (text, category, value, question type)
QUESTIONS = [
    # Allergens - can select multiple
    ("Are you allergic to Dairy?", "allergens", "Dairy", "multiple"),
    ("Are you allergic to Eggs?", "allergens", "Eggs", "multiple"),
    ("Are you allergic to Shellfish?", "allergens", "Shellfish", "multiple"),
    ("Are you allergic to Fish?", "allergens", "Fish", "multiple"),
    ("Are you allergic to Peanuts?", "allergens", "Peanuts", "multiple"),
    ("Are you allergic to Tree Nuts?", "allergens", "Tree Nuts", "multiple"),
    ("Are you allergic to Wheat?", "allergens", "Wheat", "multiple"),
    ("Are you allergic to Soy?", "allergens", "Soy", "multiple"),
    ("Are you allergic to Sesame?", "allergens", "Sesame", "multiple"),
    
    # Budget - special three-button layout
    ("What's your budget for ingredients?", "budget", "budget", "budget"),
    
    # Skill level - special three-button layout
    ("What's your cooking experience?", "skill", "intermediate", "skill"),
    
    # Time - special three-button layout
    ("How much time can you spend cooking?", "time", 30, "time"),
    
    # Dietary preferences - can select multiple
    ("Do you follow a Vegan diet?", "dietary_prefs", "vegan", "multiple"),
    ("Do you follow a Vegetarian diet?", "dietary_prefs", "vegetarian", "multiple"),
    ("Do you need Gluten-Free options?", "dietary_prefs", "gluten-free", "multiple"),
    ("Do you need Dairy-Free options?", "dietary_prefs", "dairy-free", "multiple"),
    ("Are you looking for Low-Carb recipes?", "dietary_prefs", "low-carb", "multiple"),
    ("Are you looking for High-Protein recipes?", "dietary_prefs", "high-protein", "multiple"),
    ("Do you eat fish but not meat? (Pescatarian)", "dietary_prefs", "pescatarian", "multiple"),
    
    # Health goals - can select multiple
    ("Is Weight Loss one of your goals?", "health_goals", "weight-loss", "multiple"),
    ("Is Muscle Gain one of your goals?", "health_goals", "muscle-gain", "multiple"),
    ("Is Heart Health one of your goals?", "health_goals", "heart-health", "multiple"),
    ("Do you need to control Blood Sugar?", "health_goals", "blood-sugar-control", "multiple"),
    ("Are you looking for an Energy Boost?", "health_goals", "energy-boost", "multiple"),
    
    # Kitchen equipment - can select multiple
    ("Do you have an Oven?", "equipment", "Oven", "multiple"),
    ("Do you have a Stove?", "equipment", "Stove", "multiple"),
    ("Do you have a Microwave?", "equipment", "Microwave", "multiple"),
    ("Do you have a Blender?", "equipment", "Blender", "multiple"),
    ("Do you have a Food Processor?", "equipment", "Food Processor", "multiple"),
    ("Do you have an Air Fryer?", "equipment", "Air Fryer", "multiple"),
    ("Do you have a Slow Cooker?", "equipment", "Slow Cooker", "multiple"),
    ("Do you have a Grill?", "equipment", "Grill", "multiple"),
]

# Track quiz progress
if 'current_question' not in st.session_state:
    st.session_state.current_question = 0
    
if 'answers' not in st.session_state:
    st.session_state.answers = {
        'allergens': [],  # List of tuples: (allergen_name, severity)
        'budget': [],  # Will have 1 item: (min, max)
        'skill': [],  # Will have 1 item: SkillLevel
        'time': [],  # Will have 1 item: minutes
        'dietary_prefs': [],  # List of PreferenceType
        'health_goals': [],  # List of GoalType
        'equipment': []  # List of equipment names
    }

if 'quiz_complete' not in st.session_state:
    st.session_state.quiz_complete = False


def answer_question(answer, custom_value=None):
    """Process user's answer and advance to next question"""
    question_text, category, value, q_type = QUESTIONS[st.session_state.current_question]
    
    if custom_value is not None:
        # Budget/skill/time questions use custom value
        if answer:
            st.session_state.answers[category].append(custom_value)
    else:
        if answer:
            # For allergens, also need severity
            if category == "allergens":
                severity = "moderate"  # Default severity: mild, moderate, or severe
                st.session_state.answers[category].append((value, severity))
            else:
                st.session_state.answers[category].append(value)
    
    st.session_state.current_question += 1
    
    # Quiz finished?
    if st.session_state.current_question >= len(QUESTIONS):
        st.session_state.quiz_complete = True

def reset_quiz():
    """Clear all answers and restart from beginning"""
    st.session_state.current_question = 0
    st.session_state.answers = {
        'allergens': [],
        'budget': [],
        'skill': [],
        'time': [],
        'dietary_prefs': [],
        'health_goals': [],
        'equipment': []
    }
    st.session_state.quiz_complete = False

# Show quiz questions
if not st.session_state.quiz_complete:
    progress = st.session_state.current_question / len(QUESTIONS)
    st.progress(progress)
    st.write(f"Question {st.session_state.current_question + 1} of {len(QUESTIONS)}")
        
        # No diet selected? Default to omnivore
        if prev_category == "diet" and next_category != "diet":
            if not st.session_state.answers["diet"]:
                st.session_state.answers["diet"].append(Diet.OMNIVORE)
        
        # No restrictions selected? Default to none
        if prev_category == "restrictions" and next_category != "restrictions":
            if not st.session_state.answers["restrictions"]:
                st.session_state.answers["restrictions"].append(DietRestriction.NONE)
    
    # Quiz finished?
    if st.session_state.current_question >= len(QUESTIONS):
        # Apply any missing defaults
        if not st.session_state.answers["diet"]:
            st.session_state.answers["diet"].append(Diet.OMNIVORE)
        if not st.session_state.answers["restrictions"]:
            st.session_state.answers["restrictions"].append(DietRestriction.NONE)
        
        st.session_state.quiz_complete = True

def reset_quiz():
    """Clear all answers and restart from beginning"""
    st.session_state.current_question = 0
    st.session_state.answers = {
        'diet': [],
        'restrictions': [],
        'cooking_time': [],
        'skill': [],
        'cooking_methods': [],
        'budget': [],
        'meal': [],
        'macros': []
    }
    st.session_state.quiz_complete = False

# Show quiz questions
if not st.session_state.quiz_complete:
    progress = st.session_state.current_question / len(QUESTIONS)
    st.progress(progress)
    st.write(f"Question {st.session_state.current_question + 1} of {len(QUESTIONS)}")
    
    st.divider()
    
    question_text, category, value, q_type = QUESTIONS[st.session_state.current_question]
    st.subheader(question_text)
    
    # Time question gets three buttons instead of yes/no
    if q_type == "time":
        st.markdown("""
            <style>
                div.stButton > button[kind="primary"] {
                    background-color: transparent;
                    color: #28a745;
                    border: 2px solid #28a745;
                }
                div.stButton > button[kind="primary"]:hover {
                    background-color: #28a745;
                    color: white;
                    border: 2px solid #28a745;
                }
                div.stButton > button[kind="secondary"] {
                    background-color: transparent;
                    color: #007bff;
                    border: 2px solid #007bff;
                }
                div.stButton > button[kind="secondary"]:hover {
                    background-color: #007bff;
                    color: white;
                    border: 2px solid #007bff;
                }
            </style>
        """, unsafe_allow_html=True)
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            if st.button("< 15 min", key=f"time_less_{st.session_state.current_question}", use_container_width=True, type="secondary"):
                answer_question(True, CookingTime.LESS_THAN_15)
                st.rerun()
        
        with col2:
            if st.button("15-45 min", key=f"time_yes_{st.session_state.current_question}", use_container_width=True, type="primary"):
                answer_question(True, CookingTime.BETWEEN_15_45)
                st.rerun()
        
        with col3:
            if st.button("> 45 min", key=f"time_more_{st.session_state.current_question}", use_container_width=True, type="secondary"):
                answer_question(True, CookingTime.MORE_THAN_45)
                st.rerun()
    
    # Skill question gets three buttons: Beginner/Intermediate/Experienced
    elif q_type == "skill":
        st.markdown("""
            <style>
                div.stButton > button[kind="primary"] {
                    background-color: transparent;
                    color: #28a745;
                    border: 2px solid #28a745;
                }
                div.stButton > button[kind="primary"]:hover {
                    background-color: #28a745;
                    color: white;
                    border: 2px solid #28a745;
                }   
                div.stButton > button[kind="secondary"] {
                    background-color: transparent;
                    color: #007bff;
                    border: 2px solid #007bff;
                }
                div.stButton > button[kind="secondary"]:hover {
                    background-color: #007bff;
                    color: white;
                    border: 2px solid #007bff;
                }
                div.stButton > button[kind="tertiary"] {
                    background-color: transparent;
                    color: #dc3545;
                    border: 2px solid #dc3545;
                }
                div.stButton > button[kind="tertiary"]:hover {
                    background-color: #dc3545;
                    color: white;
                    border: 2px solid #dc3545;
                }
            </style>
        """, unsafe_allow_html=True)
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            if st.button("Beginner", key=f"skill_easy_{st.session_state.current_question}", use_container_width=True, type="secondary"):
                answer_question(True, Skill.EASY)
                st.rerun()
        
        with col2:
            if st.button("Intermediate", key=f"skill_medium_{st.session_state.current_question}", use_container_width=True, type="primary"):
                answer_question(True, Skill.MEDIUM)
                st.rerun()
        
        with col3:
            if st.button("Experienced", key=f"skill_exp_{st.session_state.current_question}", use_container_width=True, type="tertiary"):
                answer_question(True, Skill.EXPERIENCED)
                st.rerun()
    
    # Budget question gets three buttons: Student Life/Budget Friendly/Gourmet
    elif q_type == "budget":
        st.markdown("""
            <style>
                div.stButton > button[kind="primary"] {
                    background-color: transparent;
                    color: #28a745;
                    border: 2px solid #28a745;
                }
                div.stButton > button[kind="primary"]:hover {
                    background-color: #28a745;
                    color: white;
                    border: 2px solid #28a745;
                }   
                div.stButton > button[kind="secondary"] {
                    background-color: transparent;
                    color: #007bff;
                    border: 2px solid #007bff;
                }
                div.stButton > button[kind="secondary"]:hover {
                    background-color: #007bff;
                    color: white;
                    border: 2px solid #007bff;
                }
                div.stButton > button[kind="tertiary"] {
                    background-color: transparent;
                    color: #dc3545;
                    border: 2px solid #dc3545;
                }
                div.stButton > button[kind="tertiary"]:hover {
                    background-color: #dc3545;
                    color: white;
                    border: 2px solid #dc3545;
                }
            </style>
        """, unsafe_allow_html=True)
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            if st.button("Budget", key=f"budget_student_{st.session_state.current_question}", use_container_width=True, type="secondary"):
                answer_question(True, Budget.BUDGET)
                st.rerun()
        
        with col2:
            if st.button("Moderate", key=f"budget_friendly_{st.session_state.current_question}", use_container_width=True, type="primary"):
                answer_question(True, Budget.MODERATE)
                st.rerun()
        
        with col3:
            if st.button("Premium", key=f"budget_gourmet_{st.session_state.current_question}", use_container_width=True, type="tertiary"):
                answer_question(True, Budget.PREMIUM)
                st.rerun()
    
    # Meal type question gets five buttons
    elif q_type == "meal":
        st.markdown("""
            <style>
                div.stButton > button[kind="primary"] {
                    background-color: transparent;
                    color: #007bff;
                    border: 2px solid #007bff;
                }
                div.stButton > button[kind="primary"]:hover {
                    background-color: #007bff;
                    color: white;
                    border: 2px solid #007bff;
                }   
                div.stButton > button[kind="secondary"] {
                    background-color: transparent;
                    color: #007bff;
                    border: 2px solid #007bff;
                }
                div.stButton > button[kind="secondary"]:hover {
                    background-color: #007bff;
                    color: white;
                    border: 2px solid #007bff;
                }
            </style>
        """, unsafe_allow_html=True)
        
        col1, col2, col3, col4, col5 = st.columns(5)
        
        with col1:
            if st.button("Breakfast", key=f"meal_breakfast_{st.session_state.current_question}", use_container_width=True, type="secondary"):
                answer_question(True, Meal.BREAKFAST)
                st.rerun()
        
        with col2:
            if st.button("Lunch", key=f"meal_lunch_{st.session_state.current_question}", use_container_width=True, type="secondary"):
                answer_question(True, Meal.LUNCH)
                st.rerun()
        
        with col3:
            if st.button("Dinner", key=f"meal_dinner_{st.session_state.current_question}", use_container_width=True, type="secondary"):
                answer_question(True, Meal.DINNER)
                st.rerun()
        
        with col4:
            if st.button("Snack", key=f"meal_snack_{st.session_state.current_question}", use_container_width=True, type="secondary"):
                answer_question(True, Meal.SNACK)
                st.rerun()
        
        with col5:
            if st.button("Dessert", key=f"meal_dessert_{st.session_state.current_question}", use_container_width=True, type="secondary"):
                answer_question(True, Meal.DESSERT)
                st.rerun()
    
    else:
        # Yes/No buttons with custom styling
        st.markdown("""
            <style>
                div.stButton > button[kind="primary"] {
                    background-color: transparent;
                    color: #28a745;
                    border: 2px solid #28a745;
                }
                div.stButton > button[kind="primary"]:hover {
                    background-color: #28a745;
                    color: white;
                    border: 2px solid #28a745;
                }
                div.stButton > button[kind="secondary"] {
                    background-color: transparent;
                    color: #dc3545;
                    border: 2px solid #dc3545;
                }
                div.stButton > button[kind="secondary"]:hover {
                    background-color: #dc3545;
                    color: white;
                    border: 2px solid #dc3545;
                }
            </style>
        """, unsafe_allow_html=True)
        
        col1, col2 = st.columns(2)
        
        with col1:
            if st.button("Yes", key=f"yes_btn_{st.session_state.current_question}", use_container_width=True, type="primary"):
                answer_question(True)
                st.rerun()
        
        with col2:
            if st.button("No", key=f"no_btn_{st.session_state.current_question}", use_container_width=True, type="secondary"):
                answer_question(False)
                st.rerun()
    
    st.divider()
    
    if st.button("üîÑ Reset Quiz", key=f"reset_btn_{st.session_state.current_question}", use_container_width=False):
        reset_quiz()
        st.rerun()

else:
    # Show summary of selected preferences
    st.success("‚úÖ All questions answered!")
    
    st.subheader("Your Preferences")
    
    col1, col2 = st.columns(2)
    
    with col1:
        if st.session_state.answers['diet']:
            st.write(f"**Diet:** {', '.join([d.value.title() for d in st.session_state.answers['diet']])}")
        else:
            st.write("**Diet:** None selected")
            
        if st.session_state.answers['cooking_time']:
            st.write(f"**Cooking Time:** {', '.join([t.value.title() for t in st.session_state.answers['cooking_time']])}")
        else:
            st.write("**Cooking Time:** None selected")
            
        if st.session_state.answers['skill']:
            st.write(f"**Skill Level:** {', '.join([s.value.title() for s in st.session_state.answers['skill']])}")
        else:
            st.write("**Skill Level:** None selected")
            
        if st.session_state.answers['budget']:
            st.write(f"**Budget:** {', '.join([b.value.title() for b in st.session_state.answers['budget']])}")
        else:
            st.write("**Budget:** None selected")
    
    with col2:
        if st.session_state.answers['meal']:
            st.write(f"**Meal Type:** {', '.join([m.value.title() for m in st.session_state.answers['meal']])}")
        else:
            st.write("**Meal Type:** None selected")
            
        if st.session_state.answers['restrictions']:
            st.write(f"**Dietary Restrictions:** {', '.join([r.value.title() for r in st.session_state.answers['restrictions']])}")
        else:
            st.write("**Dietary Restrictions:** None selected")
            
        if st.session_state.answers['cooking_methods']:
            st.write(f"**Cooking Methods:** {', '.join([m.value.title() for m in st.session_state.answers['cooking_methods']])}")
        else:
            st.write("**Cooking Methods:** None selected")
            
        if st.session_state.answers['macros']:
            st.write(f"**Nutritional Goals:** {', '.join([m.value.title() for m in st.session_state.answers['macros']])}")
        else:
            st.write("**Nutritional Goals:** None selected")
    
    st.divider()
    
    # Filter and display matching recipes
    st.subheader("üç≥ Your Recipe Matches")
    
    # Convert preferences to User object
    preferences = {
        'diet': st.session_state.answers['diet'],
        'diet_restrictions': st.session_state.answers['restrictions'],
        'cooking_time': st.session_state.answers['cooking_time'],
        'skill': st.session_state.answers['skill'],
        'cooking_methods': st.session_state.answers['cooking_methods'],
        'budget': st.session_state.answers['budget'],
        'meal': st.session_state.answers['meal'],
        'macros': st.session_state.answers['macros']
    }
    
    # Create User object from preferences
    user = preferences_to_user(preferences)
    
    # Load inference engine and apply forward-chaining
    all_recipes = get_all_recipes()
    
    # Get the knowledge base path relative to this file
    kb_path = Path(__file__).parent / 'knowledge_base.yaml'
    
    try:
        engine = InferenceEngine(str(kb_path))
        # Use forward-chaining inference to determine suitable recipes
        engine.forward_chain(user, user.kitchen, all_recipes)
        
        # Get recommended recipes sorted by score
        recommended_recipes = engine.get_recommended_recipes(all_recipes)
        
        if recommended_recipes:
            st.success(f"Found {len(recommended_recipes)} recipe(s) that match your preferences!")
            
            # Display recipes with scores
            for i, recipe in enumerate(recommended_recipes, 1):
                score = recipe.recommendation_score
                score_emoji = "‚≠ê" * min(5, max(1, int(score / 3) + 1))
                with st.expander(f"üçΩÔ∏è {recipe.name} {score_emoji}", expanded=(i == 1)):
                    # Recipe description
                    if recipe.description:
                        st.markdown(f"*{recipe.description}*")
                    
                    # Show match score
                    st.info(f"‚ú® Match Score: {score:.1f}/15")
                    
                    # Show substitution suggestions if any
                    if recipe.substitution_suggestions:
                        st.warning("üí° Suggested substitutions:")
                        for allergen, substitutes in recipe.substitution_suggestions.items():
                            st.write(f"  ‚Ä¢ Replace {allergen}: {', '.join(substitutes)}")
                    
                    st.divider()
                
                # Basic info
                col1, col2, col3 = st.columns(3)
                
                with col1:
                    st.write(f"**Diet:** {recipe.diet.value.title()}")
                    st.write(f"**Skill Level:** {recipe.skill.value.title()}")
                    if recipe.cuisine:
                        st.write(f"**Cuisine:** {recipe.cuisine}")
                
                with col2:
                    st.write(f"**Cooking Time:** {recipe.cooking_time.value.title()}")
                    if recipe.prep_time:
                        st.write(f"**Prep Time:** {recipe.prep_time} min")
                    st.write(f"**Servings:** {recipe.servings}")
                
                with col3:
                    st.write(f"**Meal Type:** {recipe.meal.value.title()}")
                    st.write(f"**Budget:** {recipe.budget.value.title()}")
                    methods = [m.value.title() for m in recipe.cooking_methods]
                    st.write(f"**Methods:** {', '.join(methods)}")
                
                # Nutritional information
                if recipe.nutritional_info and recipe.nutritional_info.calories > 0:
                    st.divider()
                    st.markdown("**üìä Nutrition (per serving)**")
                    col1, col2, col3, col4 = st.columns(4)
                    with col1:
                        st.metric("Calories", f"{int(recipe.nutritional_info.calories)}")
                    with col2:
                        st.metric("Protein", f"{int(recipe.nutritional_info.protein)}g")
                    with col3:
                        st.metric("Carbs", f"{int(recipe.nutritional_info.carbohydrates)}g")
                    with col4:
                        st.metric("Fat", f"{int(recipe.nutritional_info.fat)}g")
                
                # Ingredients
                if recipe.ingredients:
                    st.divider()
                    st.markdown("**ü•ò Ingredients**")
                    for ingredient in recipe.ingredients:
                        st.write(f"‚Ä¢ {ingredient}")
                
                # Equipment
                if recipe.equipment:
                    st.divider()
                    st.markdown("**üî™ Equipment Needed**")
                    equip_list = [eq.name.title() for eq in recipe.equipment]
                    st.write(", ".join(equip_list))
                
                # Instructions
                if recipe.instructions:
                    st.divider()
                    st.markdown("**üë©‚Äçüç≥ Instructions**")
                    for idx, instruction in enumerate(recipe.instructions, 1):
                        st.write(f"{idx}. {instruction}")
                
                # Dietary info
                restrictions = [r.value.title() for r in recipe.diet_restrictions if r != DietRestriction.NONE]
                if restrictions or recipe.macros:
                    st.divider()
                    if restrictions:
                        st.write(f"‚úÖ **Suitable for:** {', '.join(restrictions)}")
                    if recipe.macros:
                        macros = [m.value.title() for m in recipe.macros]
                        st.write(f"üí™ **Health benefits:** {', '.join(macros)}")
                
                # Substitution suggestions
                try:
                    substitutions = engine.get_substitutions(recipe, user)
                    has_subs = any(substitutions.values())
                    
                    if has_subs:
                        st.divider()
                        st.markdown("**üîÑ Substitution Suggestions**")
                        
                        if substitutions.get('ingredients'):
                            st.markdown("*Ingredient alternatives:*")
                            for original, alternatives in substitutions['ingredients'].items():
                                if alternatives:
                                    st.write(f"‚Ä¢ {original.title()} ‚Üí {', '.join(alternatives)}")
                        
                        if substitutions.get('cooking_methods'):
                            st.markdown("*Cooking method alternatives:*")
                            for original, alternatives in substitutions['cooking_methods'].items():
                                if alternatives:
                                    st.write(f"‚Ä¢ {original.title()} ‚Üí {', '.join(alternatives)}")
                        
                        if substitutions.get('equipment'):
                            st.markdown("*Equipment alternatives:*")
                            for original, alternatives in substitutions['equipment'].items():
                                if alternatives:
                                    st.write(f"‚Ä¢ {original.title()} ‚Üí {', '.join(alternatives)}")
                except Exception:
                    pass  # Skip substitutions if there's an error
    
    except Exception as e:
        st.error(f"Error using inference engine: {e}")
        st.info("Please try adjusting your preferences and try again.")
        recommended_recipes = []
    
    if not recommended_recipes:
        st.warning("üòî No recipes match all your preferences. Try adjusting your criteria!")
        st.info("üí° Tip: You can reset the quiz and try different options to find matching recipes.")
    
    st.divider()
    
    if st.button("üîÑ Start Over", use_container_width=True):
        reset_quiz()
        st.rerun()


